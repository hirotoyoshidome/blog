<!DOCTYPE html><html lang="ja"> <head><!-- Google Tag Manager --><!-- End Google Tag Manager --><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><title>MySQLの暗黙の型変換でUPDATE文がエラーになった</title><meta name="description" content="MySQLの暗黙の型変換でUPDATE文がエラーになったに関するメモ。"><!-- OGP --><meta property="og:title" content="MySQLの暗黙の型変換でUPDATE文がエラーになった"><meta name="og:description" content="MySQLの暗黙の型変換でUPDATE文がエラーになったに関するメモ。"><meta property="og:type" content="website"><!-- Twitter --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="MySQLの暗黙の型変換でUPDATE文がエラーになった"><meta name="twitter:description" content="MySQLの暗黙の型変換でUPDATE文がエラーになったに関するメモ。"><link rel="icon" type="image/png" href="/images/favicon.ico"><link rel="stylesheet" href="/_astro/_page_.Cqs_ohrY.css"><script type="module" src="/_astro/hoisted.DBccM9AK.js"></script></head> <body class="prose prose-neutral mx-auto p-6"> <!-- Google Tag Manager (noscript) --> <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TLLX6XR3" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript> <!-- End Google Tag Manager (noscript) -->  <main class="max-w-3xl mx-auto px-6 py-10 text-gray-800 leading-relaxed"> <nav aria-label="Breadcrumb" class="text-sm text-gray-500 mb-6"> <ol class="flex flex-wrap items-center gap-2 list-none"> <li><a href="/" class="text-blue-600 hover:underline">ホーム</a></li> <li aria-hidden="true" class="text-gray-400">/</li> <li><a href="/ja/" class="text-blue-600 hover:underline">記事一覧</a></li> <li aria-hidden="true" class="text-gray-400">/</li> <li class="font-semibold text-gray-700 truncate max-w-[60ch]">MySQLの暗黙の型変換でUPDATE文がエラーになった</li> </ol> </nav> <header class="mb-8"> <h1 class="text-4xl font-bold tracking-tight mb-2">MySQLの暗黙の型変換でUPDATE文がエラーになった</h1> <div class="flex flex-wrap items-center gap-3 text-sm text-gray-600"> <time datetime="2023-07-04T00:00:00.000Z"> 2023-07-04 </time> </div> <ul class="flex flex-wrap gap-2 mt-4 list-none"> <li class="text-xs bg-blue-50 text-blue-700 px-2 py-0.5 rounded-full font-medium">
#MySQL </li><li class="text-xs bg-blue-50 text-blue-700 px-2 py-0.5 rounded-full font-medium">
#SQL </li><li class="text-xs bg-blue-50 text-blue-700 px-2 py-0.5 rounded-full font-medium">
#Troubleshooting </li><li class="text-xs bg-blue-50 text-blue-700 px-2 py-0.5 rounded-full font-medium">
#Tips </li> </ul> <nav class="text-sm text-gray-600 flex flex-wrap gap-3 mt-4"> <a href="/en/posts/2023/mysql-type-convert/" class="text-blue-600 hover:underline flex items-center gap-1"> <span aria-hidden="true">⇄</span> English </a> </nav> </header> <ul>
<li>2023/07/04</li>
</ul>
<h2 id="mysqlの暗黙の型変換でupdate文がエラーになった">MySQLの暗黙の型変換でUPDATE文がエラーになった</h2>
<p>こんにちは。</p>
<p>最後に更新してから半年ほど時間が空いてしまいましたが、またブログを再開したいと思います。</p>
<p>今回は軽めのやつで、MySQLの暗黙の型変換で知らない挙動に遭遇したのでご紹介したいと思います。</p>
<h2 id="エラーになったパターン">エラーになったパターン</h2>
<p>MySQLのテーブル設計をする時に、複数の値をカンマ区切りでテキストとして保持したいケースが稀にあると思います。</p>
<p>勿論、綺麗にテーブルを分けてリレーションを張るのもよいのですが、そこまでする必要がないケースですね。</p>
<p>例えば、商品(item)と関連するタグ(tag)があったとします。
商品にタグは複数設定することができる場合、タグテーブルのidをカンマ区切りで保持したいというケースで考えてみます。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>table: item</span></span>
<span class="line"><span> id int</span></span>
<span class="line"><span> name varchar(100)</span></span>
<span class="line"><span> tag_id_list varchar(100)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>table: tag</span></span>
<span class="line"><span>  id int</span></span>
<span class="line"><span>  name varchar(100)</span></span>
<span class="line"><span></span></span></code></pre>
<p>MySQLでは暗黙の型変換があるため、タグid:1のみが設定されている商品を取得したい場合</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>SELECT *</span></span>
<span class="line"><span>FROM item</span></span>
<span class="line"><span>WHERE tag_id_list = 1 ;</span></span>
<span class="line"><span></span></span></code></pre>
<p>というクエリが成功します。</p>
<p>tag_id_list はvarcharで定義されているため、厳密には</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>SELECT *</span></span>
<span class="line"><span>FROM item</span></span>
<span class="line"><span>WHERE tag_id_list = '1' ;</span></span>
<span class="line"><span></span></span></code></pre>
<p>としてあげるのがよいですね。</p>
<p>一方、UPDATE文を発行する場合、例えばタグid:1のみが設定されているもの全てにタグid:2も追加するというクエリを発行したい場合、</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>UPDATE item</span></span>
<span class="line"><span>SET tag_id_list = '1,2'</span></span>
<span class="line"><span>WHERE tag_id_list = 1 ;</span></span>
<span class="line"><span></span></span></code></pre>
<p>とするとエラーになります。</p>
<p>この場合は、</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>UPDATE item</span></span>
<span class="line"><span>SET tag_id_list = '1,2'</span></span>
<span class="line"><span>WHERE tag_id_list = '1' ;</span></span>
<span class="line"><span></span></span></code></pre>
<p>とWHERE句の部分で文字列として、指定する必要があります。</p>
<h3 id="最後に">最後に</h3>
<p>今回はかなり初歩的な内容ですが、暗黙の型変換によって意図しない挙動が生まれてしまうことについて書きました。</p>
<p>暗黙的に型を変換してくれるプログラミング言語も同様ですが、型についてと言語仕様を知っておかないと思わぬバグが生まれてしまうことがあります。</p>
<p>この辺はしっかりと把握しておきたいですね。</p> <section class="mt-10 border-t pt-6 space-y-8"> <div class="flex flex-wrap gap-3 items-center"> <span class="text-sm text-gray-600">Share:</span> <a class="text-sm px-3 py-1.5 rounded border hover:bg-gray-50" href="https://twitter.com/intent/tweet?text=MySQL%E3%81%AE%E6%9A%97%E9%BB%99%E3%81%AE%E5%9E%8B%E5%A4%89%E6%8F%9B%E3%81%A7UPDATE%E6%96%87%E3%81%8C%E3%82%A8%E3%83%A9%E3%83%BC%E3%81%AB%E3%81%AA%E3%81%A3%E3%81%9F&url=https%3A%2F%2Fhirotoyoshidome.com%2Fja%2Fposts%2F2023%2Fmysql_type_convert%2F" rel="noopener">
X (Twitter)
</a> </div> </section> </main>  </body></html>