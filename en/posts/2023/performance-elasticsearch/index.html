<!DOCTYPE html><html lang="en"> <head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Thinking About Elasticsearch Performance</title><meta name="description" content="Pitfalls I ran into while tuning Elasticsearch queries and mappings."><!-- OGP --><meta property="og:title" content="Thinking About Elasticsearch Performance"><meta name="og:description" content="Pitfalls I ran into while tuning Elasticsearch queries and mappings."><meta property="og:type" content="website"><!-- Twitter --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="Thinking About Elasticsearch Performance"><meta name="twitter:description" content="Pitfalls I ran into while tuning Elasticsearch queries and mappings."><link rel="icon" type="image/png" href="/blog/images/favicon.ico"><link rel="stylesheet" href="/blog/_astro/_page_.C60xkf-5.css"></head> <body class="prose prose-neutral mx-auto p-6">  <main class="max-w-3xl mx-auto px-6 py-10 text-gray-800 leading-relaxed"> <nav aria-label="Breadcrumb" class="text-sm text-gray-500 mb-6"> <ol class="flex flex-wrap items-center gap-2 list-none"> <li><a href="/blog/" class="text-blue-600 hover:underline">Home</a></li> <li aria-hidden="true" class="text-gray-400">/</li> <li><a href="/blog/en/" class="text-blue-600 hover:underline">Posts</a></li> <li aria-hidden="true" class="text-gray-400">/</li> <li class="font-semibold text-gray-700 truncate max-w-[60ch]">Thinking About Elasticsearch Performance</li> </ol> </nav> <header class="mb-8"> <h1 class="text-4xl font-bold tracking-tight mb-2">Thinking About Elasticsearch Performance</h1> <div class="flex flex-wrap items-center gap-3 text-sm text-gray-600"> <time datetime="2023-01-14T00:00:00.000Z"> 2023-01-14 </time> </div> <ul class="flex flex-wrap gap-2 mt-4 list-none"> <li class="text-xs bg-blue-50 text-blue-700 px-2 py-0.5 rounded-full font-medium">
#Elasticsearch </li><li class="text-xs bg-blue-50 text-blue-700 px-2 py-0.5 rounded-full font-medium">
#Performance </li><li class="text-xs bg-blue-50 text-blue-700 px-2 py-0.5 rounded-full font-medium">
#Optimization </li><li class="text-xs bg-blue-50 text-blue-700 px-2 py-0.5 rounded-full font-medium">
#Scalability </li> </ul> <nav class="text-sm text-gray-600 flex flex-wrap gap-3 mt-4"> <a href="/blog/ja/posts/2023/performance_elasticsearch/" class="text-blue-600 hover:underline flex items-center gap-1"> <span aria-hidden="true">⇄</span> 日本語 </a> </nav> </header> <ul>
<li>2023/01/14</li>
</ul>
<h2 id="thinking-about-elasticsearch-performance">Thinking About Elasticsearch Performance</h2>
<p>Elasticsearch is an open-source search engine (<a href="https://github.com/elastic/elasticsearch">https://github.com/elastic/elasticsearch</a>). Search is tightly coupled with most web services—be it e-commerce or social—and SQL eventually hits limits either in functionality or performance. That is where Elasticsearch shines. After using it on a project, I hit a few performance issues worth noting.</p>
<h3 id="basic-flow">Basic flow</h3>
<p>Like an RDBMS, you define an index (mapping + data) and ingest documents. To try it quickly, I made a Docker setup: <a href="https://github.com/hirotoyoshidome/elasticsearch-query-etc">https://github.com/hirotoyoshidome/elasticsearch-query-etc</a>. You can query via <code>curl</code> or use Kibana (<a href="https://github.com/elastic/kibana">https://github.com/elastic/kibana</a>), which returns JSON results that are easy to consume. Official clients exist for major languages: <a href="https://www.elastic.co/guide/en/elasticsearch/client/index.html">https://www.elastic.co/guide/en/elasticsearch/client/index.html</a>.</p>
<h3 id="pitfalls-i-encountered">Pitfalls I encountered</h3>
<p><strong>1. Deeply nested mappings</strong> – Elasticsearch lets you nest structures, which is tempting when modeling parent-child relationships:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>{</span></span>
<span class="line"><span>  "store_id": 1,</span></span>
<span class="line"><span>  "store_name": "sample",</span></span>
<span class="line"><span>  "employee": [</span></span>
<span class="line"><span>    {"name": "Mike", "age": 30},</span></span>
<span class="line"><span>    {"name": "John", "age": 25}</span></span>
<span class="line"><span>  ],</span></span>
<span class="line"><span>  "location": {"prefecture": "Tokyo", "city": "Minato-ku"}</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span></code></pre>
<p>As depth grows, query performance drops sharply once the document count increases. Changing mappings later is painful, so avoid deep nesting. If you need child hits, <code>inner_hits</code> retrieves them, but it also slows down as data grows.</p>
<p><strong>2. Aggregating without filtering first</strong> – Think SQL: <code>aggregations</code> ≈ <code>GROUP BY</code>. Filtering before aggregating performs better. Elasticsearch lets you filter after the aggregation (akin to <code>HAVING</code>), but it is slower. Apply filters first, then aggregate.</p>
<p><strong>3. Embedding parameters directly in scripts</strong> – You can sort via scripts written in Painless. If you inline parameters inside the script source, Elasticsearch recompiles the script every time, hurting performance and potentially hitting compilation limits. Instead, pass parameters via the <code>params</code> mechanism so the script body stays constant and is reused.</p>
<h3 id="closing">Closing</h3>
<p>These are simple gotchas, but they bit me. Elasticsearch is powerful and well-documented, so read the docs and plan ahead. You can even handle synonym searches (e.g., “ジーパン/デニム/ジーンズ”) via synonym dictionaries—something SQL struggles with. I am still learning, but I hope this helps.</p> <section class="mt-10 border-t pt-6 space-y-8"> <div class="flex flex-wrap gap-3 items-center"> <span class="text-sm text-gray-600">Share:</span> <a class="text-sm px-3 py-1.5 rounded border hover:bg-gray-50" href="https://twitter.com/intent/tweet?text=Thinking%20About%20Elasticsearch%20Performance&url=https%3A%2F%2Fhirotoyoshidome.github.io%2Fblog%2Fen%2Fposts%2F2023%2Fperformance-elasticsearch%2F" rel="noopener">
X (Twitter)
</a> </div> </section> </main>  </body></html>